# Техническое задание: Исправление ошибок миграций таблицы `jobs`

## 1. Контекст проекта

1. Telegram-бот на Go обрабатывает аудио-сообщения и сохраняет информацию в БД Postgres.
2. Исходный код расположен в репозитории, ключевые директории:
   - `internal/` — бизнес-логика и инфраструктура
   - `migrations/` — SQL-миграции
   - `docker-compose.yml`, `Dockerfile` — инфраструктура контейнеров
3. Первичное описание проекта находится в файле `ТЗ для LLM.md` в корне.

## 2. Описание проблемы

1. В таблице `jobs` отсутствовала колонка `error_message`, из-за чего приложение падало с ошибкой:
   ```text
   column "error_message" of relation "jobs" does not exist
   ```
2. Была добавлена миграция `000004_add_error_message_column.up.sql`, однако колонка не создавалась до запуска приложения.
3. Временный hot-fix в проде:
   ```sql
   ALTER TABLE jobs ADD COLUMN IF NOT EXISTS error_message TEXT;
   ```
4. При последующих запусках возникла ошибка `null value in column "file_path"`, так как столбец `file_path` (устаревший) имел ограничение `NOT NULL`.
5. Создана миграция `000005_remove_file_path_column.up.sql` для удаления `file_path`.

## 3. Цели исправления

1. **Гарантировать** наличие `error_message` до старта приложения.
2. **Удалить** устаревший столбец `file_path` без нарушения ограничений.
3. **Проверить** последовательность и корректность всех миграций.
4. **Обновить код**:
   - Структура `entity.Job` должна содержать `ErrorMessage` и не содержать `FilePath`.
   - SQL-запросы `INSERT`/`UPDATE` в `internal/domain/repository/job_repository.go` должны использовать актуальные колонки.
5. **Пересобрать контейнеры** и убедиться в отсутствии SQL-ошибок.

## 4. Где искать информацию

| Что | Файл или папка |
| --- | --- |
| Первоначальное ТЗ | `ТЗ для LLM.md` |
| Схема БД | `migrations/000001_init_schema.up.sql` + последующие миграции |
| Логика `jobs` | `internal/domain/repository/job_repository.go` |
| Docker-настройка | `docker-compose.yml`, `Dockerfile` |
| Точка входа | `cmd/`, `internal/infrastructure/app.go` |

## 5. Шаги для выполнения

1. Изучить файл `ТЗ для LLM.md` и все миграции в `migrations/`.
2. Проверить, что:
   - `000004_add_error_message_column.up.sql` корректно добавляет колонку и копирует данные из старого поля `error` (если оно есть).
   - `000005_remove_file_path_column.up.sql` безопасно удаляет `file_path`.
3. Убедиться, что все NOT NULL-колонки заполняются при `INSERT`.
4. Пересобрать контейнер:
   ```bash
   docker compose build app
   docker compose up -d app
   ```
5. Проверить логи `obsidian_app` на отсутствие SQL-ошибок.
6. Обновить структуру `entity.Job` и соответствующие DTO/запросы, если потребуется.
7. Запустить `go vet ./...` и тесты.
8. Обновить документацию/README при изменении инструкций деплоя.

## 6. Критерии готовности

- Миграции выполняются без ошибок на чистой БД.
- Приложение стартует без ошибок `column does not exist` или `null value in column ...`.
- В таблице `jobs` присутствует `error_message` (TEXT, NULLABLE) и отсутствует `file_path`.
- Линтеры и тесты проходят.
- README обновлено при необходимости.