# Project Obsidian

Project Obsidian - это Telegram бот для обработки аудиосообщений с использованием технологий искусственного интеллекта. Бот транскрибирует аудиосообщения, создает их краткое содержание и может интегрироваться с Notion для сохранения результатов.

## Последние изменения

- Оптимизированы миграции базы данных для обеспечения атомарности и идемпотентности
- Переименованы колонки в таблице `jobs`: `file_path` → `audio_file_path` и `error` → `error_message`
- Обновлены SQL-запросы для корректной работы с полями `file_name` и `duration`
- Улучшена документация по структуре базы данных

## Основные возможности

- Транскрибация аудиосообщений и голосовых сообщений с использованием OpenAI Whisper API
- Создание краткого содержания транскрибированного текста с использованием DeepSeek API
- Интеграция с Notion для сохранения транскрипций и их кратких содержаний
- Асинхронная обработка задач с использованием очередей Redis
- Хранение данных в PostgreSQL

## Технологический стек

- Go 1.22+
- PostgreSQL
- Redis
- FFmpeg
- OpenAI Whisper API
- DeepSeek API
- Notion API
- Docker и Docker Compose

## Требования

- Go 1.22 или выше
- PostgreSQL 16
- Redis 7
- FFmpeg
- API ключи для OpenAI, DeepSeek и Notion

## Установка и запуск

### Локальная разработка

1. Клонируйте репозиторий:

```bash
git clone https://github.com/112Alex/project_obsidian.git
cd project_obsidian
```

2. Создайте файл `.env` на основе `.env.example`:

```bash
cp configs/.env.example .env
```

3. Отредактируйте файл `.env`, указав свои API ключи и настройки.

4. Установите зависимости:

```bash
go mod download
```

5. Запустите PostgreSQL и Redis (можно использовать Docker):

```bash
docker-compose up -d postgres redis
```

6. Запустите приложение:

```bash
go run cmd/app/main.go
```

### Запуск с использованием Docker

1. Создайте файл `.env` на основе `.env.example`:

```bash
cp configs/.env.example .env
```

2. Отредактируйте файл `.env`, указав свои API ключи и настройки.

3. Запустите приложение с использованием Docker Compose:

```bash
docker-compose up -d
```

## Использование

1. Найдите бота в Telegram по его имени пользователя.
2. Отправьте команду `/start` для начала работы.
3. Отправьте голосовое сообщение или аудиофайл для обработки.
4. Бот обработает аудио и вернет транскрипцию и краткое содержание.
5. Для интеграции с Notion используйте команду `/notion` и следуйте инструкциям.

## Команды бота

- `/start` - Начать работу с ботом
- `/help` - Получить справку по использованию бота
- `/notion` - Настроить интеграцию с Notion
- `/jobs` - Получить список ваших задач обработки аудио

## Структура проекта

Проект организован в соответствии с принципами Clean Architecture:

- `cmd/app` - Точка входа в приложение
- `configs` - Конфигурационные файлы
- `internal` - Внутренний код приложения
  - `config` - Конфигурация приложения
  - `domain` - Бизнес-логика и модели
    - `entity` - Сущности
    - `repository` - Интерфейсы репозиториев
    - `service` - Интерфейсы сервисов
  - `infrastructure` - Реализация инфраструктурных компонентов
    - `database` - Реализация репозиториев
    - `telegram` - Реализация Telegram бота
    - `ffmpeg` - Сервис для обработки аудио
    - `openai` - Сервис для транскрибации аудио
    - `deepseek` - Сервис для суммаризации текста
    - `notion` - Сервис для интеграции с Notion
    - `queue` - Сервис для работы с очередями
  - `usecase` - Реализация бизнес-логики
- `pkg` - Общие пакеты
  - `logger` - Пакет для логирования
- `migrations` - SQL миграции для базы данных

## Структура базы данных

### Таблица `users`

Содержит информацию о пользователях бота.

| Колонка | Тип | Описание |
|---------|-----|----------|
| id | SERIAL | Первичный ключ |
| telegram_id | BIGINT | ID пользователя в Telegram |
| notion_token | TEXT | Токен для доступа к Notion API |
| notion_page_id | TEXT | ID страницы в Notion для сохранения результатов |
| created_at | TIMESTAMP | Время создания записи |
| updated_at | TIMESTAMP | Время последнего обновления записи |

### Таблица `jobs`

Содержит информацию о задачах обработки аудио.

| Колонка | Тип | Описание |
|---------|-----|----------|
| id | SERIAL | Первичный ключ |
| user_id | INTEGER | Внешний ключ на таблицу users |
| audio_file_path | TEXT | Путь к аудиофайлу |
| file_name | TEXT | Имя файла |
| duration | INTEGER | Длительность аудио в секундах |
| transcription | TEXT | Текст транскрипции |
| summary | TEXT | Краткое содержание транскрипции |
| status | TEXT | Статус задачи (pending, processing, completed, failed) |
| error_message | TEXT | Сообщение об ошибке, если задача завершилась с ошибкой |
| created_at | TIMESTAMP | Время создания задачи |
| updated_at | TIMESTAMP | Время последнего обновления задачи |